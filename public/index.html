<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<title>Image Protector</title>
		<style>
			:root {
				--bg: #fafbfc;
				--card: #ffffff;
				--border: #e1e4e8;
				--text: #24292e;
				--text-muted: #586069;
				--accent: #0366d6;
				--accent-hover: #0256c7;
				--danger: #d73a49;
				--warning: #f9c513;
				--success: #28a745;
				--input-bg: #fafbfc;
				--shadow-sm: 0 0.125rem 0.25rem rgba(27, 31, 35, 0.04);
				--shadow-md: 0 0.5rem 1rem rgba(27, 31, 35, 0.08);
				--radius: 0.375rem;
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
				color: var(--text);
				font-size: 0.875rem;
				line-height: 1.5;
			}
			*,
			::before,
			::after {
				box-sizing: border-box;
			}
			html,
			body {
				height: 100%;
				margin: 0;
				background: var(--bg);
				-webkit-font-smoothing: antialiased;
			}
			.page {
				min-height: 100%;
				display: flex;
				flex-direction: column;
				align-items: center;
				padding: 2rem 1rem;
			}
			.card {
				width: 100%;
				max-width: 60rem;
				background: var(--card);
				border-radius: var(--radius);
				padding: 1.5rem;
				box-shadow: var(--shadow-md);
				border: 0.0625rem solid var(--border);
			}
			header {
				display: flex;
				gap: 1rem;
				align-items: center;
				margin-bottom: 1.5rem;
				padding-bottom: 1.5rem;
				border-bottom: 0.0625rem solid var(--border);
			}
			.logo {
				width: 3rem;
				height: 3rem;
				border-radius: var(--radius);
				background: var(--accent);
				display: grid;
				place-items: center;
				color: white;
				font-weight: 700;
				font-size: 1.25rem;
				flex-shrink: 0;
			}
			h1 {
				font-size: 1.5rem;
				margin: 0;
				font-weight: 600;
			}
			.lead {
				margin: 0.25rem 0 0;
				color: var(--text-muted);
				font-size: 0.875rem;
			}
			form {
				display: flex;
				flex-direction: column;
				gap: 1.5rem;
			}
			fieldset {
				border: 0.0625rem solid var(--border);
				border-radius: var(--radius);
				padding: 1rem;
				margin: 0;
			}
			legend {
				font-size: 0.875rem;
				font-weight: 600;
				color: var(--text);
				padding: 0 0.5rem;
			}
			.grid {
				display: grid;
				gap: 1rem;
			}
			.grid-2 {
				grid-template-columns: repeat(auto-fit, minmax(15rem, 1fr));
			}
			.grid-3 {
				grid-template-columns: repeat(auto-fit, minmax(10rem, 1fr));
			}
			label {
				display: block;
				font-weight: 600;
				font-size: 0.8125rem;
				margin-bottom: 0.5rem;
				color: var(--text);
			}
			input[type='file'] {
				display: block;
				width: 100%;
				font-size: 0.875rem;
			}
			input[type='url'],
			input[type='text'],
			input[type='number'],
			textarea,
			select {
				width: 100%;
				padding: 0.5rem 0.75rem;
				border-radius: var(--radius);
				border: 0.0625rem solid var(--border);
				background: var(--input-bg);
				font-size: 0.875rem;
				transition: border-color 0.15s ease;
			}
			input:focus,
			textarea:focus,
			select:focus {
				outline: none;
				border-color: var(--accent);
				box-shadow: 0 0 0 0.1875rem rgba(3, 102, 214, 0.1);
			}
			textarea {
				min-height: 5.5rem;
				resize: vertical;
				font-family: ui-monospace, monospace;
			}
			.muted {
				color: var(--text-muted);
				font-size: 0.8125rem;
				margin-top: 0.25rem;
			}
			.btn {
				display: inline-flex;
				align-items: center;
				justify-content: center;
				gap: 0.5rem;
				padding: 0.5rem 1rem;
				border-radius: var(--radius);
				border: 0.0625rem solid transparent;
				font-weight: 600;
				font-size: 0.875rem;
				cursor: pointer;
				transition: all 0.15s ease;
				white-space: nowrap;
			}
			.btn-primary {
				background: var(--accent);
				color: white;
				border-color: var(--accent);
			}
			.btn-primary:hover:not(:disabled) {
				background: var(--accent-hover);
			}
			.btn-secondary {
				background: transparent;
				color: var(--text);
				border-color: var(--border);
			}
			.btn-secondary:hover:not(:disabled) {
				background: var(--input-bg);
			}
			.btn:disabled {
				opacity: 0.5;
				cursor: not-allowed;
			}
			.controls {
				display: flex;
				gap: 0.75rem;
				align-items: center;
				justify-content: flex-end;
				flex-wrap: wrap;
			}
			.meta-rows {
				display: flex;
				flex-direction: column;
				gap: 0.5rem;
			}
			.meta-row {
				display: flex;
				gap: 0.5rem;
			}
			.meta-row input {
				flex: 1;
			}
			.meta-row button {
				padding: 0.5rem;
				border: 0.0625rem solid var(--border);
				background: white;
				border-radius: var(--radius);
				cursor: pointer;
				color: var(--danger);
			}
			.preview-wrap {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(7.5rem, 1fr));
				gap: 0.75rem;
				margin-top: 0.75rem;
			}
			.preview {
				aspect-ratio: 1;
				border-radius: var(--radius);
				border: 0.0625rem solid var(--border);
				background: var(--input-bg);
				display: flex;
				align-items: center;
				justify-content: center;
				overflow: hidden;
			}
			.preview img {
				max-width: 100%;
				max-height: 100%;
				display: block;
				object-fit: contain;
			}
			.result {
				margin-top: 1.5rem;
			}
			.result-content {
				display: flex;
				flex-direction: column;
				gap: 1rem;
				padding: 1rem;
				border: 0.0625rem solid var(--border);
				border-radius: var(--radius);
				background: var(--input-bg);
			}
			.result-preview img {
				max-width: 100%;
				height: auto;
				max-height: 18.75rem;
				border-radius: var(--radius);
				border: 0.0625rem solid var(--border);
			}
			.result-info {
				font-size: 0.8125rem;
				color: var(--text-muted);
			}
			.alert {
				padding: 0.75rem 1rem;
				border-radius: var(--radius);
				border: 0.0625rem solid;
				margin-top: 1rem;
				font-size: 0.8125rem;
			}
			.alert-warning {
				background: #fffbdd;
				border-color: #e6db74;
				color: #6b5d00;
			}
			.alert-info {
				background: #dbedff;
				border-color: #0366d6;
				color: #044289;
			}
			.disclaimer {
				margin-top: 1.5rem;
				padding: 1rem;
				background: #fffbdd;
				border: 0.0625rem solid #e6db74;
				border-radius: var(--radius);
				font-size: 0.8125rem;
				color: #6b5d00;
				text-align: center;
			}
			.disclaimer a {
				color: #6b5d00;
				font-weight: 600;
			}
			footer {
				margin-top: 1.5rem;
				padding-top: 1rem;
				border-top: 0.0625rem solid var(--border);
				display: flex;
				justify-content: space-between;
				align-items: center;
				gap: 1rem;
				flex-wrap: wrap;
				font-size: 0.8125rem;
				color: var(--text-muted);
			}
			code {
				background: #f6f8fa;
				padding: 0.125rem 0.375rem;
				border-radius: 0.1875rem;
				font-size: 0.8125rem;
				font-family: ui-monospace, monospace;
			}
			@media (max-width: 48rem) {
				.card {
					padding: 1rem;
				}
				header {
					flex-direction: column;
					align-items: flex-start;
				}
				.grid-2,
				.grid-3 {
					grid-template-columns: 1fr;
				}
				.controls {
					justify-content: stretch;
				}
				.controls .btn {
					flex: 1;
				}
			}
		</style>
	</head>
	<body>
		<div class="page">
			<section class="card">
				<header>
					<div class="logo">IP</div>
					<div>
						<h1>Image Protector</h1>
						<p class="lead">Embed EXIF metadata into JPEGs and apply image watermarks with optional compression</p>
					</div>
				</header>

				<form id="uploadForm" autocomplete="off" novalidate>
					<fieldset>
						<legend>Main Image</legend>
						<div class="grid grid-2">
							<div>
								<label for="mainFile">Upload File</label>
								<input id="mainFile" name="main_file" type="file" accept="image/*" />
								<div class="muted">JPEG required for EXIF metadata. PNG/WebP supported for watermarking only.</div>
							</div>
							<div>
								<label for="mainUrl">Public URL</label>
								<input id="mainUrl" name="main_url" type="url" placeholder="https://example.com/image.jpg" />
							</div>
						</div>
					</fieldset>

					<fieldset>
						<legend>Main Image Quality</legend>
						<div class="grid grid-3">
							<div>
								<label for="quality">Quality (1-100)</label>
								<input id="quality" name="quality" type="number" min="1" max="100" value="100" />
								<div class="muted">Lower = smaller file</div>
							</div>
							<div>
								<label for="width">Max Width (px)</label>
								<input id="width" name="width" type="number" min="0" placeholder="Original" />
								<div class="muted">Leave empty for original</div>
							</div>
							<div>
								<label for="height">Max Height (px)</label>
								<input id="height" name="height" type="number" min="0" placeholder="Original" />
								<div class="muted">Leave empty for original</div>
							</div>
						</div>
					</fieldset>

					<fieldset>
						<legend>Watermark (Optional)</legend>
						<div class="grid grid-2">
							<div>
								<label for="wmFile">Upload File</label>
								<input id="wmFile" name="watermark_file" type="file" accept="image/*" />
								<div class="muted">PNG/WebP with transparency recommended</div>
							</div>
							<div>
								<label for="wmUrl">Public URL</label>
								<input id="wmUrl" name="watermark_url" type="url" placeholder="https://example.com/watermark.png" />
							</div>
						</div>

						<div class="grid grid-3">
							<div>
								<label for="wmSize">Size</label>
								<select id="wmSize">
									<option value="10p">10% of image</option>
									<option value="15p">15% of image</option>
									<option value="20p" selected>20% of image</option>
									<option value="25p">25% of image</option>
								</select>
							</div>
							<div>
								<label for="wmOpacity">Opacity</label>
								<select id="wmOpacity">
									<option value="20">20% (subtle)</option>
									<option value="40">40%</option>
									<option value="60" selected>60%</option>
									<option value="80">80%</option>
									<option value="100">100% (solid)</option>
								</select>
							</div>
							<div>
								<label for="wmGravity">Position</label>
								<select id="wmGravity">
									<option value="center" selected>Center</option>
									<option value="northwest">Top-left</option>
									<option value="northeast">Top-right</option>
									<option value="southwest">Bottom-left</option>
									<option value="southeast" selected>Bottom-right</option>
								</select>
							</div>
						</div>
					</fieldset>

					<fieldset>
						<legend>Metadata <strong>(JPEG Only)</strong></legend>
						<div class="grid grid-2">
							<div>
								<label>Common Fields</label>
								<input id="metaAuthor" type="text" placeholder="Author / Artist" style="margin-bottom: 0.5rem" />
								<input id="metaDesc" type="text" placeholder="Description" style="margin-bottom: 0.5rem" />
								<input id="metaSource" type="text" placeholder="Source / Website" />
							</div>
							<div>
								<label>Custom Key/Value Pairs</label>
								<div class="meta-rows" id="metaRows"></div>
								<button type="button" id="addMeta" class="btn btn-secondary" style="margin-top: 0.5rem">+ Add Pair</button>
							</div>
						</div>
						<div style="margin-top: 1rem">
							<label for="metadataJson">Raw JSON (Optional)</label>
							<textarea id="metadataJson" placeholder='{"Author":"Alice","Source":"example.com"}'></textarea>
						</div>
					</fieldset>

					<section id="previewArea">
						<label>Previews</label>
						<div class="preview-wrap" id="previewWrap"></div>
					</section>

					<div class="controls">
						<button id="clearBtn" type="button" class="btn btn-secondary">Clear</button>
						<button id="submitBtn" class="btn btn-primary" type="submit">
							<svg width="14" height="14" viewBox="0 0 24 24" fill="none">
								<path d="M12 2v20M5 9l7-7 7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
							</svg>
							Process & Download
						</button>
					</div>
				</form>

				<div id="result"></div>

				<footer>
					<span>Powered by Cloudflare Workers & R2</span>
					<span>SHA-256 deterministic keys</span>
				</footer>

				<div class="disclaimer">
					<strong>Disclaimer:</strong> This is a private project for educational purposes only. For more information, visit the <a href="https://github.com/DavidJKTofan/cf-workers-exif-images" target="_blank" rel="noopener">GitHub repository</a>.
				</div>
			</section>
		</div>

		<script>
			(function () {
				const form = document.getElementById('uploadForm');
				const mainFile = document.getElementById('mainFile');
				const mainUrl = document.getElementById('mainUrl');
				const wmFile = document.getElementById('wmFile');
				const wmUrl = document.getElementById('wmUrl');
				const metadataJson = document.getElementById('metadataJson');
				const metaRows = document.getElementById('metaRows');
				const addMeta = document.getElementById('addMeta');
				const metaAuthor = document.getElementById('metaAuthor');
				const metaDesc = document.getElementById('metaDesc');
				const metaSource = document.getElementById('metaSource');
				const previewWrap = document.getElementById('previewWrap');
				const submitBtn = document.getElementById('submitBtn');
				const result = document.getElementById('result');
				const clearBtn = document.getElementById('clearBtn');
				const quality = document.getElementById('quality');
				const width = document.getElementById('width');
				const height = document.getElementById('height');

				function createMetaRow(key = '', value = '') {
					const wrap = document.createElement('div');
					wrap.className = 'meta-row';
					const k = document.createElement('input');
					k.type = 'text';
					k.placeholder = 'key';
					k.value = key;
					const v = document.createElement('input');
					v.type = 'text';
					v.placeholder = 'value';
					v.value = value;
					const rm = document.createElement('button');
					rm.type = 'button';
					rm.textContent = '×';
					rm.title = 'Remove';
					rm.addEventListener('click', () => wrap.remove());
					wrap.appendChild(k);
					wrap.appendChild(v);
					wrap.appendChild(rm);
					metaRows.appendChild(wrap);
					return wrap;
				}

				addMeta.addEventListener('click', () => createMetaRow());
				if (!metaRows.querySelector('.meta-row')) createMetaRow('Copyright', '');

				function clearPreviews() {
					previewWrap.innerHTML = '';
				}
				function addPreview(src, label) {
					const box = document.createElement('div');
					box.className = 'preview';
					if (src instanceof File) {
						const reader = new FileReader();
						reader.onload = () => {
							if (src.type?.startsWith('image')) {
								const img = document.createElement('img');
								img.src = reader.result;
								box.appendChild(img);
							} else box.textContent = 'file';
						};
						reader.readAsDataURL(src);
					} else if (typeof src === 'string' && src.trim()) {
						const img = document.createElement('img');
						img.src = src;
						img.onerror = () => (box.textContent = 'error');
						box.appendChild(img);
					} else box.textContent = label || '';
					previewWrap.appendChild(box);
				}

				function refreshPreviews() {
					clearPreviews();
					if (mainFile.files?.[0]) addPreview(mainFile.files[0], 'main');
					else if (mainUrl.value) addPreview(mainUrl.value, 'main');
					if (wmFile.files?.[0]) addPreview(wmFile.files[0], 'wm');
					else if (wmUrl.value) addPreview(wmUrl.value, 'wm');
				}

				mainFile.addEventListener('change', refreshPreviews);
				mainUrl.addEventListener('input', refreshPreviews);
				wmFile.addEventListener('change', refreshPreviews);
				wmUrl.addEventListener('input', refreshPreviews);

				function collectMetadata() {
					const raw = metadataJson.value?.trim();
					if (raw) {
						try {
							const parsed = JSON.parse(raw);
							if (parsed && typeof parsed === 'object') return parsed;
						} catch (e) {}
					}
					const out = {};
					if (metaAuthor.value.trim()) out.Author = metaAuthor.value.trim();
					if (metaDesc.value.trim()) out.Description = metaDesc.value.trim();
					if (metaSource.value.trim()) out.Source = metaSource.value.trim();
					metaRows.querySelectorAll('.meta-row').forEach((r) => {
						const k = r.children[0].value.trim(),
							v = r.children[1].value.trim();
						if (k) out[k] = v;
					});
					return out;
				}

				clearBtn.addEventListener('click', () => {
					form.reset();
					metadataJson.value = '';
					metaRows.innerHTML = '';
					createMetaRow('Copyright', '');
					refreshPreviews();
					result.innerHTML = '';
				});

				function isMainLikelyJpeg() {
					if (mainFile.files?.[0]) {
						const t = mainFile.files[0].type || '';
						return /jpeg|jpg/i.test(t);
					}
					const u = mainUrl.value?.trim();
					return u ? /\.(jpe?g)(\?.*)?$/i.test(u) : false;
				}

				form.addEventListener('submit', async (ev) => {
					ev.preventDefault();
					result.innerHTML = '';
					submitBtn.disabled = true;

					const meta = collectMetadata();
					const hasMetadata = Object.keys(meta).length > 0;
					const hasMainFile = mainFile.files?.[0];
					const hasMainUrl = mainUrl.value?.trim();

					if (!hasMainFile && !hasMainUrl) {
						result.innerHTML = '<div class="alert alert-warning">Provide a main image file or URL.</div>';
						submitBtn.disabled = false;
						return;
					}

					// Show warning if metadata provided for non-JPEG
					if (hasMetadata && !isMainLikelyJpeg()) {
						result.innerHTML =
							'<div class="alert alert-warning">Metadata will not be embedded. Main image must be JPEG for EXIF support. Continuing with watermark only.</div>';
					}

					result.innerHTML += '<div class="alert alert-info">Processing...</div>';

					const fd = new FormData();
					if (hasMainFile) fd.append('main_file', mainFile.files[0]);
					else if (hasMainUrl) fd.append('main_url', mainUrl.value.trim());

					if (wmFile.files?.[0]) fd.append('watermark_file', wmFile.files[0]);
					else if (wmUrl.value?.trim()) fd.append('watermark_url', wmUrl.value.trim());

					fd.append('wm_size', document.getElementById('wmSize').value);
					fd.append('wm_opacity', document.getElementById('wmOpacity').value);
					fd.append('wm_gravity', document.getElementById('wmGravity').value);
					fd.append('metadata_json', JSON.stringify(meta));

					// Add quality and dimensions
					const q = parseInt(quality.value, 10);
					if (!isNaN(q) && q >= 1 && q <= 100) fd.append('quality', q.toString());
					const w = parseInt(width.value, 10);
					if (!isNaN(w) && w > 0) fd.append('width', w.toString());
					const h = parseInt(height.value, 10);
					if (!isNaN(h) && h > 0) fd.append('height', h.toString());

					try {
						const res = await fetch('/process', { method: 'POST', body: fd });
						if (!res.ok) {
							let err;
							try {
								err = await res.json();
							} catch (e) {
								err = { error: res.statusText };
							}
							result.innerHTML = '<div class="alert alert-warning">Error: ' + (err?.error || JSON.stringify(err)) + '</div>';
							return;
						}
						const blob = await res.blob();
						const url = URL.createObjectURL(blob);
						const disp = res.headers.get('content-disposition') || '';
						let fname = 'protected-image.jpg';
						const m = disp.match(/filename\*=UTF-8''([^;\n]+)/i) || disp.match(/filename=\"?([^\";\n]+)\"?/i);
						if (m?.[1]) fname = decodeURIComponent(m[1].replace(/\s/g, '_'));

						const preview = document.createElement('div');
						preview.className = 'result-content';
						const img = document.createElement('img');
						img.src = url;
						img.className = 'result-preview';
						const a = document.createElement('a');
						a.href = url;
						a.download = fname;
						a.textContent = 'Download Protected Image';
						a.className = 'btn btn-primary';
						const info = document.createElement('div');
						info.className = 'result-info';
						info.textContent = `${fname} • ${(blob.size / 1024).toFixed(1)} KB`;

						preview.appendChild(img);
						preview.appendChild(a);
						preview.appendChild(info);
						result.innerHTML = '';
						result.appendChild(preview);
					} catch (err) {
						result.innerHTML = '<div class="alert alert-warning">Network error</div>';
					} finally {
						submitBtn.disabled = false;
					}
				});

				refreshPreviews();
			})();
		</script>
	</body>
</html>
