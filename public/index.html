<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<title>Image Protector</title>
		<style>
			:root {
				--bg: #f5f7fb;
				--card: #ffffff;
				--muted: #6b7280;
				--accent: #0b66ff;
				--glass: rgba(11, 102, 255, 0.06);
				--radius: 12px;
				font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
				color: #0f172a;
				font-size: 15px;
			}
			html,
			body {
				height: 100%;
				margin: 0;
				background: linear-gradient(180deg, var(--bg), #eef2fb 60%);
				-webkit-font-smoothing: antialiased;
			}
			.page {
				min-height: 100%;
				display: flex;
				align-items: center;
				justify-content: center;
				padding: 28px;
				box-sizing: border-box;
			}

			.card {
				width: 100%;
				max-width: 980px;
				background: var(--card);
				border-radius: var(--radius);
				padding: 22px;
				box-shadow: 0 8px 30px rgba(13, 24, 40, 0.07);
				border: 1px solid rgba(15, 23, 42, 0.03);
				box-sizing: border-box;
			}

			header {
				display: flex;
				gap: 16px;
				align-items: center;
				margin-bottom: 14px;
			}
			.logo {
				width: 48px;
				height: 48px;
				border-radius: 10px;
				background: linear-gradient(135deg, var(--accent), #5fb0ff);
				display: grid;
				place-items: center;
				color: white;
				font-weight: 700;
				box-shadow: 0 6px 18px rgba(11, 102, 255, 0.12);
			}
			h1 {
				font-size: 18px;
				margin: 0;
			}
			p.lead {
				margin: 0;
				color: var(--muted);
				font-size: 13px;
			}

			form {
				margin-top: 14px;
			}
			fieldset {
				border: 1px solid #7d8289;
				border-radius: 10px;
				padding: 14px;
				margin-bottom: 12px;
			}
			legend {
				font-size: 12px;
				color: var(--muted);
				padding: 0 6px;
			}
			.grid-2 {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 12px;
			}
			label {
				display: block;
				font-weight: 600;
				font-size: 13px;
				margin-bottom: 8px;
				color: #0f172a;
			}
			input[type='file'] {
				display: block;
			}
			input[type='url'],
			input[type='text'],
			textarea,
			select {
				width: 100%;
				padding: 10px;
				border-radius: 8px;
				border: 1px solid #e6eefb;
				background: #fbfdff;
				box-sizing: border-box;
				font-size: 14px;
			}
			textarea {
				min-height: 88px;
				resize: vertical;
			}

			.row {
				display: flex;
				gap: 8px;
				align-items: center;
			}
			.controls {
				display: flex;
				gap: 12px;
				align-items: center;
			}
			.btn {
				display: inline-flex;
				align-items: center;
				gap: 8px;
				padding: 10px 14px;
				border-radius: 10px;
				border: 0;
				font-weight: 700;
				color: #fff;
				background: var(--accent);
				cursor: pointer;
				box-shadow: 0 6px 18px rgba(11, 102, 255, 0.12);
			}
			.btn.ghost {
				background: transparent;
				color: var(--accent);
				border: 1px solid rgba(11, 102, 255, 0.12);
				font-weight: 600;
			}
			.btn[disabled] {
				opacity: 0.5;
				cursor: not-allowed;
				box-shadow: none;
			}

			.muted {
				color: var(--muted);
				font-size: 13px;
			}
			.small {
				font-size: 13px;
				color: var(--muted);
			}

			.meta-area {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 12px;
			}
			.meta-rows {
				display: flex;
				flex-direction: column;
				gap: 8px;
			}
			.meta-row {
				display: flex;
				gap: 8px;
			}
			.meta-row input {
				flex: 1;
				padding: 8px;
				border-radius: 8px;
				border: 1px solid #eef4ff;
				background: #fff;
			}

			.previewWrap {
				display: flex;
				gap: 12px;
				flex-wrap: wrap;
				margin-top: 8px;
			}
			.preview {
				width: 120px;
				height: 120px;
				border-radius: 10px;
				border: 1px solid #eef4ff;
				background: linear-gradient(180deg, #fbfdff, #f7fbff);
				display: flex;
				align-items: center;
				justify-content: center;
				overflow: hidden;
				box-shadow: inset 0 -4px 18px rgba(11, 102, 255, 0.02);
			}
			.preview img {
				max-width: 100%;
				max-height: 100%;
				display: block;
			}

			#result {
				margin-top: 12px;
				display: flex;
				gap: 12px;
				align-items: center;
				flex-wrap: wrap;
			}

			footer {
				margin-top: 14px;
				display: flex;
				justify-content: space-between;
				gap: 12px;
				align-items: center;
			}
			code.badge {
				background: #f1f5f9;
				padding: 6px 8px;
				border-radius: 8px;
				font-size: 12px;
				color: var(--muted);
				border: 1px solid #eef2ff;
			}

			/* responsive */
			@media (max-width: 720px) {
				.grid-2,
				.meta-area {
					grid-template-columns: 1fr;
				}
				header {
					gap: 10px;
				}
				.logo {
					width: 44px;
					height: 44px;
				}
			}
		</style>
	</head>
	<body>
		<div class="page">
			<section class="card" aria-labelledby="title">
				<header>
					<div class="logo">IP</div>
					<div>
						<h1 id="title">Image Protector</h1>
						<p class="lead">Embed EXIF metadata into JPEGs and apply image watermarks before publishing.</p>
					</div>
				</header>

				<form id="uploadForm" autocomplete="off" novalidate>
					<fieldset>
						<legend>Main image</legend>
						<div class="grid-2">
							<div>
								<label for="mainFile">Main image – file (preferred)</label>
								<input id="mainFile" name="main_file" type="file" accept="image/jpeg,image/jpg" />
								<div class="small muted">
									Only JPEG is allowed when embedding EXIF metadata. Otherwise watermarking works with other formats.
								</div>
							</div>
							<div>
								<label for="mainUrl">Main image – public URL</label>
								<input id="mainUrl" name="main_url" type="url" placeholder="https://example.com/image.jpg" />
							</div>
						</div>
					</fieldset>

					<fieldset>
						<legend>Watermark (optional)</legend>

						<div class="grid-2">
							<div>
								<label for="wmFile">Watermark – file</label>
								<input id="wmFile" name="watermark_file" type="file" accept="image/png,image/webp,image/jpeg" />
								<div class="small muted">PNG or WebP with transparency recommended.</div>
							</div>
							<div>
								<label for="wmUrl">Watermark – public URL</label>
								<input id="wmUrl" name="watermark_url" type="url" placeholder="https://example.com/watermark.png" />
								<div class="small muted">For text: pre-generate as PNG using Canva or Photoshop.</div>
							</div>
						</div>

						<div style="display: flex; gap: 12px; margin-top: 12px; align-items: flex-end; flex-wrap: wrap">
							<div style="flex: 1; min-width: 150px">
								<label for="wmSize">Watermark size</label>
								<select id="wmSize">
									<option value="10p">10% of image</option>
									<option value="15p">15% of image</option>
									<option value="20p" selected>20% of image</option>
									<option value="25p">25% of image</option>
								</select>
							</div>
							<div style="flex: 1; min-width: 120px">
								<label for="wmOpacity">Opacity</label>
								<select id="wmOpacity">
									<option value="20">20% (subtle)</option>
									<option value="40">40%</option>
									<option value="60" selected>60%</option>
									<option value="80">80%</option>
									<option value="100">100% (solid)</option>
								</select>
							</div>
							<div style="flex: 1; min-width: 140px">
								<label for="wmGravity">Position</label>
								<select id="wmGravity">
									<option value="center" selected>Center</option>
									<option value="northwest">Top-left</option>
									<option value="northeast">Top-right</option>
									<option value="southwest">Bottom-left</option>
									<option value="southeast">Bottom-right</option>
									<option value="north">Top center</option>
									<option value="south">Bottom center</option>
									<option value="west">Left center</option>
									<option value="east">Right center</option>
								</select>
							</div>
						</div>
					</fieldset>

					<fieldset>
						<legend>Metadata to embed (JPEG only)</legend>
						<div class="meta-area">
							<div>
								<label>Common fields</label>
								<input id="metaAuthor" type="text" placeholder="Author / Artist" />
								<div style="height: 8px"></div>
								<input id="metaDesc" type="text" placeholder="Description / ImageDescription" />
								<div style="height: 8px"></div>
								<input id="metaSource" type="text" placeholder="Source / Website" />
							</div>

							<div>
								<label>Custom key/value pairs</label>
								<div class="meta-rows" id="metaRows"></div>
								<div style="margin-top: 10px">
									<button type="button" id="addMeta" class="btn ghost">+ Add pair</button>
								</div>
							</div>
						</div>

						<div style="margin-top: 12px">
							<label for="metadataJson">Raw metadata JSON (optional – overrides fields)</label>
							<textarea id="metadataJson" name="metadata_json" placeholder='{"Author":"Alice","Source":"example.com"}'></textarea>
						</div>
					</fieldset>

					<div style="display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap">
						<div class="small muted">Uploads are POSTed to <code class="badge">/process</code>. EXIF only applies to JPEG outputs.</div>
						<div class="controls">
							<button id="submitBtn" class="btn" type="submit">
								<svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden>
									<path
										d="M12 2v20M5 9l7-7 7 7"
										stroke="currentColor"
										stroke-width="1.6"
										stroke-linecap="round"
										stroke-linejoin="round"
									/></svg
								>Protect & Download
							</button>
							<button id="clearBtn" type="button" class="btn ghost">Clear</button>
						</div>
					</div>
				</form>
				<div id="result"></div>
				<section id="previewArea" style="margin-top: 16px">
					<label class="small">Previews</label>
					<div class="previewWrap" id="previewWrap" aria-live="polite"></div>
				</section>
				<footer style="margin-top: 14px">
					<span class="small muted">Deterministic R2 keys. No third-party libraries.</span>
					<span class="small muted">Watermark will be clamped to avoid covering the full image.</span>
				</footer>
			</section>
		</div>
		<script>
			(function () {
				const form = document.getElementById('uploadForm');
				const mainFile = document.getElementById('mainFile');
				const mainUrl = document.getElementById('mainUrl');
				const wmFile = document.getElementById('wmFile');
				const wmUrl = document.getElementById('wmUrl');
				const metadataJson = document.getElementById('metadataJson');
				const metaRows = document.getElementById('metaRows');
				const addMeta = document.getElementById('addMeta');
				const metaAuthor = document.getElementById('metaAuthor');
				const metaDesc = document.getElementById('metaDesc');
				const metaSource = document.getElementById('metaSource');
				const previewWrap = document.getElementById('previewWrap');
				const submitBtn = document.getElementById('submitBtn');
				const result = document.getElementById('result');
				const wmSize = document.getElementById('wmSize');
				const wmOpacity = document.getElementById('wmOpacity');
				const wmGravity = document.getElementById('wmGravity');
				const clearBtn = document.getElementById('clearBtn');

				function createMetaRow(key = '', value = '') {
					const wrap = document.createElement('div');
					wrap.className = 'meta-row';
					const k = document.createElement('input');
					k.type = 'text';
					k.placeholder = 'key';
					k.value = key;
					const v = document.createElement('input');
					v.type = 'text';
					v.placeholder = 'value';
					v.value = value;
					const rm = document.createElement('button');
					rm.type = 'button';
					rm.textContent = '✕';
					rm.title = 'Remove';
					rm.style.padding = '6px 8px';
					rm.addEventListener('click', () => wrap.remove());
					wrap.appendChild(k);
					wrap.appendChild(v);
					wrap.appendChild(rm);
					metaRows.appendChild(wrap);
					return wrap;
				}

				if (addMeta) addMeta.addEventListener('click', () => createMetaRow());

				if (!metaRows.querySelector('.meta-row')) createMetaRow('Copyright', '');

				function clearPreviews() {
					previewWrap.innerHTML = '';
				}
				function addPreview(src, label) {
					const box = document.createElement('div');
					box.className = 'preview';
					if (src instanceof File) {
						const reader = new FileReader();
						reader.onload = () => {
							if (src.type && src.type.startsWith('image')) {
								const img = document.createElement('img');
								img.src = reader.result;
								box.appendChild(img);
							} else {
								box.textContent = 'file';
							}
						};
						reader.readAsDataURL(src);
					} else if (typeof src === 'string' && src.trim() !== '') {
						const img = document.createElement('img');
						img.src = src;
						img.onerror = () => (box.textContent = 'preview failed');
						box.appendChild(img);
					} else box.textContent = label || '';
					previewWrap.appendChild(box);
				}
				function refreshPreviews() {
					clearPreviews();
					if (mainFile.files && mainFile.files[0]) addPreview(mainFile.files[0], 'main');
					else if (mainUrl.value) addPreview(mainUrl.value, 'main');
					if (wmFile.files && wmFile.files[0]) addPreview(wmFile.files[0], 'wm');
					else if (wmUrl.value) addPreview(wmUrl.value, 'wm');
				}
				mainFile.addEventListener('change', refreshPreviews);
				mainUrl.addEventListener('input', refreshPreviews);
				wmFile.addEventListener('change', refreshPreviews);
				wmUrl.addEventListener('input', refreshPreviews);

				function collectMetadata() {
					const raw = metadataJson.value && metadataJson.value.trim();
					if (raw) {
						try {
							const parsed = JSON.parse(raw);
							if (parsed && typeof parsed === 'object') return parsed;
						} catch (e) {}
					}
					const out = {};
					if (metaAuthor.value.trim()) out.Author = metaAuthor.value.trim();
					if (metaDesc.value.trim()) out.Description = metaDesc.value.trim();
					if (metaSource.value.trim()) out.Source = metaSource.value.trim();
					metaRows.querySelectorAll('.meta-row').forEach((r) => {
						const k = r.children[0].value.trim(),
							v = r.children[1].value.trim();
						if (k) out[k] = v;
					});
					return out;
				}

				function setResultText(txt) {
					result.textContent = txt;
				}

				clearBtn.addEventListener('click', () => {
					form.reset();
					metadataJson.value = '';
					metaRows.innerHTML = '';
					createMetaRow('Copyright', '');
					refreshPreviews();
					result.innerHTML = '';
				});

				function isMainLikelyJpeg() {
					if (mainFile.files && mainFile.files[0]) {
						const t = mainFile.files[0].type || '';
						return /jpeg|jpg/i.test(t);
					}
					const u = mainUrl.value && mainUrl.value.trim();
					if (!u) return false;
					return /\.(jpe?g)(\?.*)?$/i.test(u);
				}

				async function postProcessResponse(res) {
					if (!res.ok) {
						let err;
						try {
							err = await res.json();
						} catch (e) {
							err = { error: res.statusText };
						}
						setResultText('Error: ' + (err?.error || JSON.stringify(err)));
						return;
					}
					const blob = await res.blob();
					const url = URL.createObjectURL(blob);

					// Create download link
					const a = document.createElement('a');
					a.href = url;
					const disp = res.headers.get('content-disposition') || '';
					let fname = 'protected-image.jpg';
					const m = disp.match(/filename\*=UTF-8''([^;\n]+)/i) || disp.match(/filename=\"?([^\";\n]+)\"?/i);
					if (m && m[1]) fname = decodeURIComponent(m[1].replace(/\s/g, '_'));
					a.download = fname;
					a.textContent = '✓ Download Protected Image';
					a.className = 'btn';

					// Create preview
					const preview = document.createElement('div');
					preview.style.cssText = 'display:flex;flex-direction:column;gap:8px;';
					const img = document.createElement('img');
					img.src = url;
					img.style.cssText = 'max-width:400px;max-height:300px;border-radius:8px;border:1px solid #e6eefb;';
					const info = document.createElement('div');
					info.className = 'small muted';
					info.textContent = `File: ${fname} • Size: ${(blob.size / 1024).toFixed(1)} KB`;

					preview.appendChild(img);
					preview.appendChild(a);
					preview.appendChild(info);

					result.innerHTML = '';
					result.appendChild(preview);
				}

				form.addEventListener('submit', async (ev) => {
					ev.preventDefault();
					result.innerHTML = '';
					setResultText('Processing…');
					submitBtn.disabled = true;

					const meta = collectMetadata();
					const hasMetadata = Object.keys(meta).length > 0;
					const hasMainFile = mainFile.files && mainFile.files[0];
					const hasMainUrl = mainUrl.value && mainUrl.value.trim();

					if (!hasMainFile && !hasMainUrl) {
						setResultText('Provide a main image file or URL before submitting.');
						submitBtn.disabled = false;
						return;
					}

					if (hasMetadata && !isMainLikelyJpeg()) {
						setResultText('When embedding metadata, the main image must be a JPEG. Provide a JPEG file or a .jpg/.jpeg URL.');
						submitBtn.disabled = false;
						return;
					}

					const fd = new FormData();
					if (hasMainFile) fd.append('main_file', mainFile.files[0]);
					else if (hasMainUrl) fd.append('main_url', mainUrl.value.trim());

					// Image watermark only
					if (wmFile.files && wmFile.files[0]) fd.append('watermark_file', wmFile.files[0]);
					else if (wmUrl.value.trim()) fd.append('watermark_url', wmUrl.value.trim());

					fd.append('wm_size', wmSize.value);
					fd.append('wm_opacity', wmOpacity.value);
					fd.append('wm_gravity', wmGravity.value);
					fd.append('metadata_json', JSON.stringify(meta));

					try {
						const res = await fetch('/process', { method: 'POST', body: fd });
						await postProcessResponse(res);
					} catch (err) {
						setResultText('Network or server error');
					} finally {
						submitBtn.disabled = false;
					}
				});

				metadataJson.addEventListener('keydown', (e) => {
					if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) submitBtn.click();
				});

				refreshPreviews();
			})();
		</script>
	</body>
</html>
